问题

* 1.2  ：  Latency versus  Bandwidth

* 2.2 p102 认真对照MIPS的每条指令与RV32I的指令。发现RV32I做出的一系列改动，并解释为什么做出这些改动  

* 3.2 p27

  interlock、nop、stall、bubble区别

  * ![image-20210630174800416](D:\科大\大三下\计算机体系结构\image\image-20210630174800416.png)

* 3.2 ppt 67例题

* 3.2 ppt 72：Latency和Repeat Interval

* 3.2 ppt91-98 MIPS R4000 浮点数操作

* 4.2 ppt 3  AMAT的计算为啥有那个比例

* 4.2 ppt8 例题（即2020年考试题）

* 4.2 ppt 45 图

* 4.2 ppt 69 分块？

* 4.2 ppt最后几页的例题

* 4.3 ppt p135-137

* 5.2 loop example没看

## 1.1 intro-history

* 计算机体系结构的定义：9-10
* 优秀的ISA所具有的特征：ppt13

* 计算机组成、计算机实现：ppt16
* 指令集架构vs微体系结构：ppt18
* 提高性能的路径： Domain Specific Architectures(DSAs)
  根据应用特征调整体系结构来实现更高的效率  ppt35
  * 对于特定的领域，更有效的挖掘计算并行性
  * 对于特定的领域，更有效的利用内存带宽
  * 消除不必要的精度  
* From CISC to Risc ：ppt44

* VLIW超长指令字及其问题：47-48

## 1.2 perf 性能分析

#### 计算机分类

* 个人移动设备
* 桌面计算
* 服务器
* 集群/仓储级计算机
* 嵌入式计算机、物联网

#### 能耗Energy(E)与功耗power(P)

* 热设计功率TDP：通常低于峰值功耗，高于平均功耗

* 功耗(Power) 指单位时间的能耗： 1 Watt = 1 Joule / Second  

* E=pt

* 能耗是一种更合适的度量指标

* 动态能耗：$E= C * V^2$

  动态功耗： $P = C*V^2*f$ 

  C是capacitive load， f是时钟频率， V是电压

* 降低频率可以降低功耗
  降低频率导致执行时间增加 ->不能降低能耗
  降低电压可有效降低功耗和能耗  

* 减少动态功耗的技术：ppt20

  * DVFS：低功耗技术

* 静态功耗：ppt23

  * 当晶体管处于off状态时,漏电流产生的功耗称为静态功耗
  * 随着晶体管尺寸的减少漏电流的大小在增加  
  * Static Power = Static Current × Voltage  
  * Power Gating: 通过切断供电减少漏电流 

* 总结

  Power Consumed = Dynamic Power +Static Power
  – 晶体管开和关的切换导致的功耗为动态功耗
  – 由于晶体管静态漏电流导致的功耗称为静态功耗  

#### 现代体系结构发展趋势

* 性能提升的基本手段： 并行  
* 工艺发展的趋势
  – 芯片的集成度不断提高，但提升的速度在放缓
  – 时钟频率的提高在放缓，并有降低的趋势  

* 体系结构的发展及机遇
  – 指令集并行受到制约
  – 线程级并行和数据级并行是发展的方向
  – 提高单处理器性能花费的代价呈现上升趋势
  – 面向特定领域的体系结构正蓬勃发展  

#### 定量分析技术基础

##### 性能的含义

* 以时间度量性能
  * 响应时间（Response Time  ）：从任务开始到任务完成所经历的时间  ，通常由最终用户观察和测量  

    Response Time = CPU Time + Waiting Time (I/O, scheduling, etc.)  

  * CPU Execution Time  

    指执行程序（指令序列）所花费的时间
    – 不包括等待I/O或系统调度的开销
    – 可以用秒(msec, µsec, …) , 或
    – 可以用相对值（CPU的时钟周期数 (clock cycles)）  

* 以吞吐率度量性能

  * 吞吐率：单位时间完成的任务数
    * 缩短任务执行时间可提高吞吐率
    * 硬件并行可提高吞吐率和响应时间（减少等待时间可缩短响应时间  ）    
  * 带宽

* 相对性能：![image-20210630105027214](D:\科大\大三下\计算机体系结构\image\image-20210630105027214.png)

##### CPU性能度量

* CPU性能公式：CPI![image-20210630105203774](D:\科大\大三下\计算机体系结构\image\image-20210630105203774.png)

  不同指令有不同的CPI

  ![image-20210630105258760](D:\科大\大三下\计算机体系结构\image\image-20210630105258760.png)

##### 计算机系统性能度量

* Amdahl's Law

  * 如果只针对整个任务的一部分进行优化，那么所获得的加速比不大于1/(1-F)  , F为加速部分在原时间的占比 
  * ![image-20210630105739295](D:\科大\大三下\计算机体系结构\image\image-20210630105739295.png)
  * Amdahl定律的假设
    * 问题规模是常量
    * 研究随着处理器数目的增加性能的变化  

* 另一视角（区别于amdahl）

  * 我们通常用更快的计算机解决更大规模的问题
  * 将处理时间视为常量，研究随着处理器数目的
    增加问题规模的增加情况（可扩放性）
  * Gustafson–Barsis’s Law （古斯塔夫森定律）  

* 基本评估方法（市场评估方法）

  * MIPS：每秒百万条指令数 【millions of instructions per second】  

    MIPS = IC/(execution time x 106)=1/(CPI * T *$10^6$)  

    – MIPS依赖于指令集
    – 在同一台机器上， MIPS因程序不同而变化，有时差别较大
    – MIPS可能与性能相反  

  * MFLOPS ：每秒百万个浮点操作

    基于操作而非指令，它可以用来比较两种不同的机器。
    但MFLOPS也并非可靠，因为不同机器上浮点运算集不同  

  * Benchmark测试

    * 五种类型的测试程序
      * 真实程序  
      * 修改过的程序  
      * 核心程序  
      * 小测试程序  
      * 合成测试程序  ：首先对大量的应用程序中 的操作进行统计，得到各种操作比例，再按这个比例人造出测试程序

  * 性能的综合评价

    ![image-20210630111123433](D:\科大\大三下\计算机体系结构\image\image-20210630111123433.png)

  * SPEC性能综合

    ![image-20210630111326703](D:\科大\大三下\计算机体系结构\image\image-20210630111326703.png)

  * 几何平均的两个重要特性

    ![image-20210630111401932](D:\科大\大三下\计算机体系结构\image\image-20210630111401932.png)

    * 几何平均的比率等于比率的几何平均
    * 几何平均的比率 等于 性能比率的几何平均
      – 与参考机器的选择无关  

## 2.1 ISA

* 指令集架构ISA的含义：ppt3

  * 软件子系统与硬件子系统的关键页面
  * 包括：
  * 应具备的特性

  ![image-20210630113606329](D:\科大\大三下\计算机体系结构\image\image-20210630113606329.png)

* 用户级ISA和特权级ISA

  * 用户级ISA适用于操作系统和应用程序
  * 特权级ISA适用于硬件资源的管理（OS）

* ISA的实现

  * 需考虑特定的微体系结构实现方式
    * Accumulator、CISC、RISC、VLIW、JVM

* ISA的演进

  * Accumulator
  * Stack
  * Register-Memory
  * Register-Register

* ISA需要specify

  * 指令格式和编码方式 （定长或变长）
  * 操作数和操作结果的存放位置、寻址方式
  * 数据类型和大小
  * 支持的操作
  * 下一条指令地址

#### 存储器寻址

* 按字节编址，不同体系结构对word定义不同

* 将字节地址映射到字地址：尾端问题

  从左到右

  big endian：大尾端，也称大端（高位）优先存储。

    little endian：小尾端，也称小端（低位）优先存储。

  ![image-20210630114435942](D:\科大\大三下\计算机体系结构\image\image-20210630114435942.png)

  ![image-20210630114655973](D:\科大\大三下\计算机体系结构\image\image-20210630114655973.png)

* 字放在任何字节边界上？  对齐问题

  ![image-20210630114932252](D:\科大\大三下\计算机体系结构\image\image-20210630114932252.png)

* 寻址方式

  ![image-20210630115109338](D:\科大\大三下\计算机体系结构\image\image-20210630115109338.png)

* MIPS

  * MIPS寻址方式：ppt17

  * MIPS寄存器

    ![image-20210630115227419](D:\科大\大三下\计算机体系结构\image\image-20210630115227419.png)

#### 操作数类型与大小

* 类型由操作码确定或数据附加硬件解释的标记
* 操作数的表示![image-20210630115432825](D:\科大\大三下\计算机体系结构\image\image-20210630115432825.png)
* MIPS数据表示![image-20210630115611199](D:\科大\大三下\计算机体系结构\image\image-20210630115611199.png)

#### 所支持的操作

* ISA对操作类型的选择

  ![image-20210630115749747](D:\科大\大三下\计算机体系结构\image\image-20210630115749747.png)

* CISC vs RISC

  * CISC（Complex Instruction Set Computer）
    * 目标：强化指令功能，减少运行的指令条数，以提高系统性能
    * 基本方法：面向目标程序的优化，面向高级语言和编译器的优化

  * RISC（Reduced Instruction Set Computer）
    * 目标：通过简化指令系统，用最高效的方法实现最常用的指令
    * 主要手段：充分发挥流水线的效率，降低（优化）CPI

#### 控制转移类指令

* 寻址方式：
  * pc相对寻址
* 控制类指令：条件分支、跳转、过程调用、过程返回
* ![image-20210630120302223](D:\科大\大三下\计算机体系结构\image\image-20210630120302223.png)
* ![image-20210630120356148](D:\科大\大三下\计算机体系结构\image\image-20210630120356148.png)

#### 指令格式

* 指令格式选择策略

  ![image-20210630120503192](D:\科大\大三下\计算机体系结构\image\image-20210630120503192.png)

* MIPS的指令格式

  * 寻址方式编码到操作码中
  * 定长：所有指令32位
  * 操作码占6位
  * 3种指令格式：I类，R类，J类

  * I类指令![image-20210630120607973](D:\科大\大三下\计算机体系结构\image\image-20210630120607973.png)

    ![image-20210630120634680](D:\科大\大三下\计算机体系结构\image\image-20210630120634680.png)

  * R类指令

    ![image-20210630120657576](D:\科大\大三下\计算机体系结构\image\image-20210630120657576.png)

  * J类指令

    ![image-20210630120710745](D:\科大\大三下\计算机体系结构\image\image-20210630120710745.png)

  * MIPS指令可分为4类

    * load/store （内存访问）
    * ALU操作
    * 分支与跳转
    * 浮点操作

## 2.2 ISA

#### ISA设计历史

以下均讲的是RISC(除了x86)

##### MIPS

* 最典型的RISC指令集架构

* 主要特征

  ![image-20210630121013207](D:\科大\大三下\计算机体系结构\image\image-20210630121013207.png)

* 主要缺陷

  * ![image-20210630121107181](D:\科大\大三下\计算机体系结构\image\image-20210630121107181.png)

  * ![image-20210630121235421](D:\科大\大三下\计算机体系结构\image\image-20210630121235421.png)

  * ![image-20210630121404619](D:\科大\大三下\计算机体系结构\image\image-20210630121404619.png)
  * ![image-20210630121517909](D:\科大\大三下\计算机体系结构\image\image-20210630121517909.png)

##### SPARC

ppt58-61

* 主要特征
* 主要问题

##### Alpha

ppt62-63

##### ARMv7 ， v8

ppt64-67

##### OpenRISC

pt68

##### 80x86

ppt69-70

* CISC

#### ISA的功能设计 CISC vs RISC

* RISC和CISC：前者需要更复杂的编译支持；后者需要更复杂的硬件支持

* CISC计算机的ISA功能设计

  * 目标：强化指令功能，减少指令条数，以提高系统性能  

  * 基本优化方法

    * 面向目标程序的优化是提高计算机系统性能最直接方法  

      优化目标
      • 缩短程序的长度
      • 缩短程序的执行时间
      优化方法
      • 统计分析目标程序执行情况，找出使用频度高，执行时间长的指令或指令串
      • 优化使用频度高的指令
      • 用新的指令代替使用频度高的指令串  

      如：

      1. 增强运算型指令的功能
      2. 增强数据传送类指令的功能
      3. 增强程序控制指令的功能

    * 面向高级语言和编译程序改进指令系统
      优化目标：主要是缩小HL-ML之间的差距  

      优化方法

      * 增强面向HL和Compiler支持的指令功能  
      * 高级语言计算机系统
      * 支持操作系统的优化实现一些特权指令 

* RISC

  * 减少指令平均执行周期数 CPI 是RISC思想的精华  

  * RISC为什么会减少CPI

    * 硬件方面

      硬布线控制逻辑
      减少指令和寻址方式的种类
      使用固定格式
      采用Load/Store
      指令执行过程中设置多级流水线。

    * 软件方面：十分强调优化编译的作用  

* ISA的功能设计：任务为确定硬件支持哪些操作。
  方法是统计的方法。存在CISC和RISC两种类型  

#### RISC-V ISA

* 技术目标

  ![image-20210630162715536](D:\科大\大三下\计算机体系结构\image\image-20210630162715536.png)

* 特点

  ![image-20210630162908391](D:\科大\大三下\计算机体系结构\image\image-20210630162908391.png)

* 指令编码

  ![image-20210630163026503](D:\科大\大三下\计算机体系结构\image\image-20210630163026503.png)

* 指令格式

  ![image-20210630163131535](D:\科大\大三下\计算机体系结构\image\image-20210630163131535.png)

* 具体的指令表：ppt 99-100

* RISC-V指令执行阶段

  ![image-20210630163622512](D:\科大\大三下\计算机体系结构\image\image-20210630163622512.png)

* 处理器设计可以分为datapath和Control设计两部分
  – datapath, 存储数据、算术逻辑运算单元
  – control, 控制数据通路上的一系列操作  

* ==微程序控制RISC-V的单总线数据通路：ppt105-及之后==



## 3 pipeline-hazards

#### 流水线简介

* 典型的RISC 5段流水线

  ![image-20210630164744642](D:\科大\大三下\计算机体系结构\image\image-20210630164744642.png)

* 流水线技术要点

  ![image-20210630164944754](D:\科大\大三下\计算机体系结构\image\image-20210630164944754.png)

* 单周期、多周期、流水线控制性能比较：ppt10

#### 流水线的相关

![image-20210630165137423](D:\科大\大三下\计算机体系结构\image\image-20210630165137423.png)

* 消除结构相关

  ![image-20210630165225907](D:\科大\大三下\计算机体系结构\image\image-20210630165225907.png)

* 数据相关

  ![image-20210630174643674](D:\科大\大三下\计算机体系结构\image\image-20210630174643674.png)

  消除数据相关的3种策略

  * ![image-20210630165401740](D:\科大\大三下\计算机体系结构\image\image-20210630165401740.png)

    interlock就是插入bubble，即让当前指令滞留，直到相关接触

    ![image-20210630165605546](D:\科大\大三下\计算机体系结构\image\image-20210630165605546.png)

  * 采用软件方法避免数据相关：即调整汇编代码顺序

* 控制相关

  * 计算下一条指令地址的方法

    ![image-20210630170613300](D:\科大\大三下\计算机体系结构\image\image-20210630170613300.png)

  * 早期RISC机器采用延迟槽技术

    软件必须用有用的工作填充延迟槽，或者用显示的NOP指令填充

    问题：![image-20210630170756454](D:\科大\大三下\计算机体系结构\image\image-20210630170756454.png)

  * 为什么在经典的5段流水线中指令不能在每个周期都被分发

    ![image-20210630171040197](D:\科大\大三下\计算机体系结构\image\image-20210630171040197.png)

#### 陷阱和中断

* ![image-20210630174832537](D:\科大\大三下\计算机体系结构\image\image-20210630174832537.png)

* 异步中断

  **精确中断**

  ![image-20210630174931899](D:\科大\大三下\计算机体系结构\image\image-20210630174931899.png)

  嵌套中断![image-20210630171718312](D:\科大\大三下\计算机体系结构\image\image-20210630171718312.png)

* 同步陷阱

  ![image-20210630171813845](D:\科大\大三下\计算机体系结构\image\image-20210630171813845.png)

* 如何处理不同流水段的多个并发异常

  如何以及在哪里处理外部异步中断

  ![image-20210630175023789](D:\科大\大三下\计算机体系结构\image\image-20210630175023789.png)

  ![image-20210630172019125](D:\科大\大三下\计算机体系结构\image\image-20210630172019125.png)

* 异常的推测

  ![image-20210630172156362](D:\科大\大三下\计算机体系结构\image\image-20210630172156362.png)

#### 流水线性能分析

* 基本度量方法：吞吐率、加速比、效率

##### 吞吐率

![image-20210630172432382](D:\科大\大三下\计算机体系结构\image\image-20210630172432382.png)

* 时间相等的流水线![image-20210630172601453](D:\科大\大三下\计算机体系结构\image\image-20210630172601453.png)

  ![image-20210630172632771](D:\科大\大三下\计算机体系结构\image\image-20210630172632771.png)

* 各段时间不等的流水线：瓶颈为最慢的段

  ![image-20210630172741989](D:\科大\大三下\计算机体系结构\image\image-20210630172741989.png)

* 解决流水线瓶颈问题的常用方法

  * 细分瓶颈段
  * 重复设置瓶颈段（增加硬件）

##### 加速比

* ![image-20210630172932492](D:\科大\大三下\计算机体系结构\image\image-20210630172932492.png)

* 各段时间相等的流水线

  ![image-20210630175252883](D:\科大\大三下\计算机体系结构\image\image-20210630175252883.png)

* 各段时间不等的流水线

  ![image-20210630173037373](D:\科大\大三下\计算机体系结构\image\image-20210630173037373.png)

##### 效率

* ![image-20210630175317695](D:\科大\大三下\计算机体系结构\image\image-20210630175317695.png)

  ![image-20210630173404050](D:\科大\大三下\计算机体系结构\image\image-20210630173404050.png)

* ![image-20210630173540860](D:\科大\大三下\计算机体系结构\image\image-20210630173540860.png)

* ![image-20210630173547640](D:\科大\大三下\计算机体系结构\image\image-20210630173547640.png)



总结

* ![image-20210630173939013](D:\科大\大三下\计算机体系结构\image\image-20210630173939013.png)

流水线的加速比计算

* ![image-20210630175345381](D:\科大\大三下\计算机体系结构\image\image-20210630175345381.png)

解决控制相关的办法

* ![image-20210630175727660](D:\科大\大三下\计算机体系结构\image\image-20210630175727660.png)

#### 对整型pipeline增加浮点数处理RISC-V

* 多周期操作的处理

  ![image-20210630180003890](D:\科大\大三下\计算机体系结构\image\image-20210630180003890.png)

* 对MIPS的扩充

  ![image-20210630180021594](D:\科大\大三下\计算机体系结构\image\image-20210630180021594.png)

  ![image-20210630180211345](D:\科大\大三下\计算机体系结构\image\image-20210630180211345.png)

* Latency和Repeat Interval

  ![image-20210630194219229](D:\科大\大三下\计算机体系结构\image\image-20210630194219229.png)

* 新的相关和定向问题

  ![image-20210630194458235](D:\科大\大三下\计算机体系结构\image\image-20210630194458235.png)

  新的结构相关

  ![image-20210630194518658](D:\科大\大三下\计算机体系结构\image\image-20210630194518658.png)

* 解决方法

  ![image-20210630194654077](D:\科大\大三下\计算机体系结构\image\image-20210630194654077.png)

数据相关![image-20210630194824647](D:\科大\大三下\计算机体系结构\image\image-20210630194824647.png)

* 新的冲突源

  ![image-20210630194926470](D:\科大\大三下\计算机体系结构\image\image-20210630194926470.png)

* 精确中断与长流水线

  ![image-20210630195042278](D:\科大\大三下\计算机体系结构\image\image-20210630195042278.png)

* 精确中断与非精确中断

  ![image-20210630195142090](D:\科大\大三下\计算机体系结构\image\image-20210630195142090.png)

* 处理中断的4种可能方法

  ![image-20210630195323297](D:\科大\大三下\计算机体系结构\image\image-20210630195323297.png)

  ![image-20210630195407938](D:\科大\大三下\计算机体系结构\image\image-20210630195407938.png)

#### MIPS R4000

* 64bit机器

* 8级整数流水线![image-20210630195442517](D:\科大\大三下\计算机体系结构\image\image-20210630195442517.png)

  ![image-20210630195538275](D:\科大\大三下\计算机体系结构\image\image-20210630195538275.png)

  注意事项![image-20210630195700129](D:\科大\大三下\计算机体系结构\image\image-20210630195700129.png)

  ![image-20210630195820094](D:\科大\大三下\计算机体系结构\image\image-20210630195820094.png)

* MIPS R4000 浮点数操作

  ![image-20210630195904877](D:\科大\大三下\计算机体系结构\image\image-20210630195904877.png)

  ![image-20210630195941202](D:\科大\大三下\计算机体系结构\image\image-20210630195941202.png)

* 小结

  ![image-20210630200218788](D:\科大\大三下\计算机体系结构\image\image-20210630200218788.png)

## 4.1 memory-cache

#### 存储层次结构

* 存储系统的设计目标：通过优化存储系统的组织来使得针对典型应用平均访存时间最短

* 基本解决方法：多级层次结构、并行

  ![image-20210630201454803](D:\科大\大三下\计算机体系结构\image\image-20210630201454803.png)

* 典型的存储器访问模式

  ![image-20210630201552168](D:\科大\大三下\计算机体系结构\image\image-20210630201552168.png)

  存储层次工作原理

  * 时间局部性
  * 空间局部性

* 存储层次结构涉及的基本概念

  ![image-20210630201706640](D:\科大\大三下\计算机体系结构\image\image-20210630201706640.png)

* 存储层次的性能参数

  ![image-20210630201909423](D:\科大\大三下\计算机体系结构\image\image-20210630201909423.png)

  ![image-20210630201919856](D:\科大\大三下\计算机体系结构\image\image-20210630201919856.png)

* 常见的存储层次的组织

  ![image-20210630202007132](D:\科大\大三下\计算机体系结构\image\image-20210630202007132.png)

* Cache memory

  ![image-20210630202034547](D:\科大\大三下\计算机体系结构\image\image-20210630202034547.png)


#### Cache基本知识

* ![image-20210630202246420](D:\科大\大三下\计算机体系结构\image\image-20210630202246420.png)

##### Q1：映像规则

![image-20210630202309884](D:\科大\大三下\计算机体系结构\image\image-20210630202309884.png)

![image-20210630202445466](D:\科大\大三下\计算机体系结构\image\image-20210630202445466.png)

讨论

![image-20210630202550371](D:\科大\大三下\计算机体系结构\image\image-20210630202550371.png)

##### Q2: 查找方法

![image-20210630204323453](D:\科大\大三下\计算机体系结构\image\image-20210630204323453.png)

![image-20210630204440755](D:\科大\大三下\计算机体系结构\image\image-20210630204440755.png)

* 并行访问的逻辑结构

  ![image-20210630204554570](D:\科大\大三下\计算机体系结构\image\image-20210630204554570.png)

* 串行访问的逻辑结构

  ![image-20210630204812705](D:\科大\大三下\计算机体系结构\image\image-20210630204812705.png)

* 更多图示：ppt28-29

##### Q3 替换算法

![image-20210630205211758](D:\科大\大三下\计算机体系结构\image\image-20210630205211758.png)

![image-20210630205221666](D:\科大\大三下\计算机体系结构\image\image-20210630205221666.png)

##### Q4 写策略

* 主要解决的问题：何时更新主存

* ![image-20210630205519934](D:\科大\大三下\计算机体系结构\image\image-20210630205519934.png)

  ![image-20210630205743018](D:\科大\大三下\计算机体系结构\image\image-20210630205743018.png)

  ![image-20210630205747614](D:\科大\大三下\计算机体系结构\image\image-20210630205747614.png)

## 4.2 memory improvement

#### 基本的Cache优化方法

* Cache性能分析

  ![image-20210630210214399](D:\科大\大三下\计算机体系结构\image\image-20210630210214399.png)

* ![image-20210630211253721](D:\科大\大三下\计算机体系结构\image\image-20210630211253721.png)

* 改进Cache性能的方法

  ![image-20210630211555153](D:\科大\大三下\计算机体系结构\image\image-20210630211555153.png)

  ![image-20210630211624512](D:\科大\大三下\计算机体系结构\image\image-20210630211624512.png)

##### 降低失效率

![image-20210630211739763](D:\科大\大三下\计算机体系结构\image\image-20210630211739763.png)

![image-20210630211820485](D:\科大\大三下\计算机体系结构\image\image-20210630211820485.png)

减少上述3C的方法（3类失效）

![image-20210630211939095](D:\科大\大三下\计算机体系结构\image\image-20210630211939095.png)

* 块大小、容量的权衡

  ![image-20210630212211578](D:\科大\大三下\计算机体系结构\image\image-20210630212211578.png)

* 提高相联度

  ![image-20210630212405213](D:\科大\大三下\计算机体系结构\image\image-20210630212405213.png)

* Victim Cache

  在Cache和Memory间增加一个小的全相联Cache

  ![image-20210630212512036](D:\科大\大三下\计算机体系结构\image\image-20210630212512036.png)

##### 减少失效开销

* 手段：多级Cache技术、让读优先于写

* 多级Cache技术![image-20210630212657245](D:\科大\大三下\计算机体系结构\image\image-20210630212657245.png)

  * 多级包容性

    ![image-20210630212748034](D:\科大\大三下\计算机体系结构\image\image-20210630212748034.png)

    例子：ppt28-9

  * 多级不包容

    ![image-20210630213308770](D:\科大\大三下\计算机体系结构\image\image-20210630213308770.png)

    例子ppt31

* 多级Cache的性能分析

  ![image-20210630213713999](D:\科大\大三下\计算机体系结构\image\image-20210630213713999-1625060234174.png)

  * L1Cache失效率

    ![image-20210630213954303](D:\科大\大三下\计算机体系结构\image\image-20210630213954303.png)

    求AMAT的例子：ppt34

  * ![image-20210630214419132](D:\科大\大三下\计算机体系结构\image\image-20210630214419132.png)

  * 两级Cache性能的计算例子：ppt36
  
  * 两级Cache的一些结论
  
    ![image-20210701112646676](D:\科大\大三下\计算机体系结构\image\image-20210701112646676.png)
  
  ![image-20210701112727764](D:\科大\大三下\计算机体系结构\image\image-20210701112727764.png)

* 让读优先于写

  ![image-20210701113117878](D:\科大\大三下\计算机体系结构\image\image-20210701113117878.png)

##### 缩短命中时间

* 避免在索引缓存期间进行地址转换

  即使用Virtually indexed cache

  ![image-20210701113244178](D:\科大\大三下\计算机体系结构\image\image-20210701113244178.png)

* ![image-20210701113643740](D:\科大\大三下\计算机体系结构\image\image-20210701113643740.png)

#### 高级的Cache优化方法

##### 缩短命中时间

* 小而简单的第一级cache

  ![image-20210701114002412](D:\科大\大三下\计算机体系结构\image\image-20210701114002412.png)

* 路预测方法

  ![image-20210701114050047](D:\科大\大三下\计算机体系结构\image\image-20210701114050047.png)

##### 增加Cache带宽

* Cache访问流水化

  ![image-20210701114202796](D:\科大\大三下\计算机体系结构\image\image-20210701114202796.png)

* 无阻塞cache

  ![image-20210701114443858](D:\科大\大三下\计算机体系结构\image\image-20210701114443858.png)

  ![image-20210701114614558](D:\科大\大三下\计算机体系结构\image\image-20210701114614558.png)

  用到的结构：MSHR（Miss Status Holding register)

  ![image-20210701114715151](D:\科大\大三下\计算机体系结构\image\image-20210701114715151.png)

  ![image-20210701115024998](D:\科大\大三下\计算机体系结构\image\image-20210701115024998.png)

* 多体Cache

  ![image-20210701115112583](D:\科大\大三下\计算机体系结构\image\image-20210701115112583.png)

  Multibanked caches

  ![image-20210701115202672](D:\科大\大三下\计算机体系结构\image\image-20210701115202672.png)

##### 减小失效开销

* 关键字优先和提前重启

  ![image-20210701115241913](D:\科大\大三下\计算机体系结构\image\image-20210701115241913.png)

* 合并写

  ![image-20210701115356079](D:\科大\大三下\计算机体系结构\image\image-20210701115356079.png)

##### 降低失效率

* 编译器优化

  ![image-20210701115514279](D:\科大\大三下\计算机体系结构\image\image-20210701115514279.png)

例子：ppt66-68

##### 通过并行降低失效开销或失效率

* 硬件预取

  ![image-20210701115804359](D:\科大\大三下\计算机体系结构\image\image-20210701115804359.png)

  ![image-20210701115900288](D:\科大\大三下\计算机体系结构\image\image-20210701115900288.png)

* 编译器控制的预取

  ![image-20210701115951134](D:\科大\大三下\计算机体系结构\image\image-20210701115951134.png)

  ![image-20210701120124558](D:\科大\大三下\计算机体系结构\image\image-20210701120124558.png)

## 4.3 memory

#### 存储器技术与优化

* ![image-20210701120453635](D:\科大\大三下\计算机体系结构\image\image-20210701120453635.png)

* ![image-20210701120604337](D:\科大\大三下\计算机体系结构\image\image-20210701120604337.png)

* ![image-20210701120652318](D:\科大\大三下\计算机体系结构\image\image-20210701120652318.png)

* 存储器的一些优化方法

  ![image-20210701120749091](D:\科大\大三下\计算机体系结构\image\image-20210701120749091.png)

  * 对同一行的多个访问端口
  * 同步DRAM、关键字优先
  * 提高带宽
  * DDR：时钟上升、下降沿都可以数据传输
  * 多banks

* 3种存储器组织方式

  ![image-20210701121009324](D:\科大\大三下\计算机体系结构\image\image-20210701121009324.png)

##### 提高主存性能的方法

* 增大存储器宽度

  ![image-20210701121246239](D:\科大\大三下\计算机体系结构\image\image-20210701121246239.png)

* 采用简单的多体交叉存储器

  ![image-20210701121300983](D:\科大\大三下\计算机体系结构\image\image-20210701121300983.png)

  ![image-20210701121438138](D:\科大\大三下\计算机体系结构\image\image-20210701121438138.png)

  地址映射方法：ppt133

#### 虚拟存储器-基本原理

* ![image-20210701122408438](D:\科大\大三下\计算机体系结构\image\image-20210701122408438.png)

* Cache与VM的区别

  ![image-20210701122627680](D:\科大\大三下\计算机体系结构\image\image-20210701122627680.png)

* 页式管理和段式管理

  ![image-20210701122929295](D:\科大\大三下\计算机体系结构\image\image-20210701122929295.png)

* VM的四个问题

  ![image-20210701123053763](D:\科大\大三下\计算机体系结构\image\image-20210701123053763.png)

  ![image-20210701123148941](D:\科大\大三下\计算机体系结构\image\image-20210701123148941.png)

* 页面大小的选择

  ![image-20210701123206510](D:\科大\大三下\计算机体系结构\image\image-20210701123206510.png)

* 分级页表

* ![image-20210701123439293](D:\科大\大三下\计算机体系结构\image\image-20210701123439293.png)

* TLB

  ![image-20210701123610704](D:\科大\大三下\计算机体系结构\image\image-20210701123610704.png)



## 5.1 ILP

#### 指令集并行的基本概念及挑战

* 系统结构的Flynn分类：SISD、SIMD、MISD、MIMD

  ![image-20210701145305886](D:\科大\大三下\计算机体系结构\image\image-20210701145305886.png)

* 并行的层次

  ![image-20210701145321131](D:\科大\大三下\计算机体系结构\image\image-20210701145321131.png)

* 流水线知识回顾

  ![image-20210701145509863](D:\科大\大三下\计算机体系结构\image\image-20210701145509863.png)

* 指令级并行ILP

  ![image-20210701145540069](D:\科大\大三下\计算机体系结构\image\image-20210701145540069.png)

* 本章遵循的指令延时

  ![image-20210701145721419](D:\科大\大三下\计算机体系结构\image\image-20210701145721419.png)

#### 软件方法挖掘指令级并行

##### 基本块内的指令级并行

* ![image-20210701145800494](D:\科大\大三下\计算机体系结构\image\image-20210701145800494.png)

* 例子：ppt11-12的代码，在此基础上进行优化

  1. 直接调整指令顺序 13

  2. 循环展开四次 14

  3. 循环展开四次并调整代码位置 15

  循环展开例子小结

  ![image-20210701150437955](D:\科大\大三下\计算机体系结构\image\image-20210701150437955.png)

* 从编译器角度看代码移动

  ![image-20210701150608965](D:\科大\大三下\计算机体系结构\image\image-20210701150608965.png)

  ![image-20210701150658896](D:\科大\大三下\计算机体系结构\image\image-20210701150658896.png)

  名相关的解决：寄存器重命名

  ![image-20210701150939943](D:\科大\大三下\计算机体系结构\image\image-20210701150939943.png)

* 循环间相关

  ![image-20210701151225520](D:\科大\大三下\计算机体系结构\image\image-20210701151225520.png)

  无回路的循环间相关

  ![image-20210701151334636](D:\科大\大三下\计算机体系结构\image\image-20210701151334636.png)

  ![image-20210701151349012](D:\科大\大三下\计算机体系结构\image\image-20210701151349012.png)

#### 硬件方法挖掘指令级并行

* 为何要用硬件调度方案![image-20210701151521778](D:\科大\大三下\计算机体系结构\image\image-20210701151521778.png)

##### Scoreboard

* CDC6600：顺序发射，乱序执行，乱序完成，无定向技术，非精确中断

* ![image-20210701151646100](D:\科大\大三下\计算机体系结构\image\image-20210701151646100.png)

* 记分牌控制的四阶段

  ![image-20210701151715059](D:\科大\大三下\计算机体系结构\image\image-20210701151715059.png)

  ![image-20210701151757850](D:\科大\大三下\计算机体系结构\image\image-20210701151757850.png)

* Scoreboard结构

  ![image-20210701151832694](D:\科大\大三下\计算机体系结构\image\image-20210701151832694.png)

* 例子：ppt39起

  ![image-20210701152104625](D:\科大\大三下\计算机体系结构\image\image-20210701152104625.png)

  ![image-20210701153020198](D:\科大\大三下\计算机体系结构\image\image-20210701153020198.png)

* 为何要顺序发射

  ![image-20210701153041965](D:\科大\大三下\计算机体系结构\image\image-20210701153041965.png)

* ![image-20210701153205186](D:\科大\大三下\计算机体系结构\image\image-20210701153205186.png)

* ![image-20210701153459201](D:\科大\大三下\计算机体系结构\image\image-20210701153459201.png)

##### Tomasulo

* ![image-20210701153702180](D:\科大\大三下\计算机体系结构\image\image-20210701153702180.png)

  通过寄存器重命名 解决了Scoreboard里未解决的WAW和WAR

* 算法特点

  ![image-20210701160411944](D:\科大\大三下\计算机体系结构\image\image-20210701160411944.png)

* Reservation station 结构

  ![image-20210701154654541](D:\科大\大三下\计算机体系结构\image\image-20210701154654541.png)

* 算法3阶段

  ![image-20210701160114470](D:\科大\大三下\计算机体系结构\image\image-20210701160114470.png)

* 例子 ppt83起

  ![image-20210701154909544](D:\科大\大三下\计算机体系结构\image\image-20210701154909544.png)

  ![image-20210701155304363](D:\科大\大三下\计算机体系结构\image\image-20210701155304363.png)

  ![image-20210701155831531](D:\科大\大三下\计算机体系结构\image\image-20210701155831531.png)

* 与Scoreboard的对比

  ![image-20210701155901773](D:\科大\大三下\计算机体系结构\image\image-20210701155901773.png)

  ![image-20210701160351247](D:\科大\大三下\计算机体系结构\image\image-20210701160351247.png)

* Tomasulo缺陷

  ![image-20210701160517735](D:\科大\大三下\计算机体系结构\image\image-20210701160517735.png)

* 总结![image-20210701160848119](D:\科大\大三下\计算机体系结构\image\image-20210701160848119.png)

  ![image-20210701165201316](D:\科大\大三下\计算机体系结构\image\image-20210701165201316.png)

## 5.2

#### 跨越基本块的指令级并行

* Tomasulo循环展开示例

## 5.3

* 关于异常处理

  ![image-20210701161036936](D:\科大\大三下\计算机体系结构\image\image-20210701161036936.png)

* 进行循环重叠执行需要尽快解决分支问题

  ![image-20210701161146571](D:\科大\大三下\计算机体系结构\image\image-20210701161146571.png)

* 控制相关的动态解决技术

  ![image-20210701161252550](D:\科大\大三下\计算机体系结构\image\image-20210701161252550.png)

* 分支对性能的影响

  ![image-20210701161315979](D:\科大\大三下\计算机体系结构\image\image-20210701161315979.png)

* ![image-20210701161501871](D:\科大\大三下\计算机体系结构\image\image-20210701161501871.png)

#### 基于硬件的推测执行（分支预测）

* 基于BHT表、基于BTB表

##### 基于BHT

* 动态分支预测

  ![image-20210701161613949](D:\科大\大三下\计算机体系结构\image\image-20210701161613949.png)

* 1 bit BHT

  ![image-20210701161710426](D:\科大\大三下\计算机体系结构\image\image-20210701161710426.png)

* 2 bit BHT

  ![image-20210701161737608](D:\科大\大三下\计算机体系结构\image\image-20210701161737608.png)

* BHT Accuracy

  ![image-20210701161753058](D:\科大\大三下\计算机体系结构\image\image-20210701161753058.png)

* Correlating Branch Predictor 也即两级预测器：根据其他分支的行为来进行预测

  在这种策略中，某条指令的跳转不是只由自己来决定的，而是由刚执行过的N条跳转指令的跳转情况来决定的。 这是由于在程序中某条指令跳转与否也与其他的跳转指令相关。所以会利用刚执行完的N条跳转指令来获取跳转信息。 这刚执行完的N条指令的跳转情况组成了一个查询的Key，这个Key值对应的内容就是跳转的状态。状态机同上。
  个人感觉这种分支预测技术对于循环的预测效果应该是相当好的，尤其是多重循环，并且每重循环次数又不多的情况

  ![image-20210701162447550](D:\科大\大三下\计算机体系结构\image\image-20210701162447550.png)

  ![image-20210701163030867](D:\科大\大三下\计算机体系结构\image\image-20210701163030867.png)

* ![image-20210701164357741](D:\科大\大三下\计算机体系结构\image\image-20210701164357741.png)

  竞赛预测器

  ![image-20210701164817585](D:\科大\大三下\计算机体系结构\image\image-20210701164817585.png)

* 总结

  ![image-20210701164509419](D:\科大\大三下\计算机体系结构\image\image-20210701164509419.png)

##### 基于BTB

* ![image-20210701164940745](D:\科大\大三下\计算机体系结构\image\image-20210701164940745.png)

  具体流程图参考lab4

##### 硬件支持推断执行以及精确中断 ，ROB

![image-20210701165352804](D:\科大\大三下\人工智能基础\期末复习\image-20210701165352804.png)

* 支持推断执行的Tomasulo算法的四阶段

  ![image-20210701165521246](D:\科大\大三下\计算机体系结构\image\image-20210701165521246.png)

* ![image-20210701170826057](D:\科大\大三下\计算机体系结构\image\image-20210701170826057.png)

* 使用ROB保持机器的精确状态

  ![image-20210701171125762](D:\科大\大三下\计算机体系结构\image\image-20210701171125762.png)

小结

![image-20210701171512148](D:\科大\大三下\计算机体系结构\image\image-20210701171512148.png)

## 5.4

#### memory Disambiguation

* ![image-20210701171247148](D:\科大\大三下\计算机体系结构\image\image-20210701171247148.png)

  ![image-20210701171301378](D:\科大\大三下\计算机体系结构\image\image-20210701171301378.png)

* ![image-20210701171534366](D:\科大\大三下\计算机体系结构\image\image-20210701171534366.png)

  ![image-20210701172505624](D:\科大\大三下\计算机体系结构\image\image-20210701172505624.png)

* Load ordering. Store ordering

  ![image-20210701172549898](D:\科大\大三下\计算机体系结构\image\image-20210701172549898.png)

  * store操作

    ![image-20210701172700733](D:\科大\大三下\计算机体系结构\image\image-20210701172700733.png)

  * load操作

    ![image-20210701172802085](D:\科大\大三下\计算机体系结构\image\image-20210701172802085.png)

* Partial Ordering：ppt8-9

* Speculative Memory Disambiguation

  ![image-20210701173616318](D:\科大\大三下\计算机体系结构\image\image-20210701173616318.png)

#### 以多发射和静态调度来挖掘指令级并行

如何使CPI<1

* ![image-20210701173717837](D:\科大\大三下\计算机体系结构\image\image-20210701173717837.png)

  超标量：具有多种执行部件，可流水化

  ![image-20210701173734912](D:\科大\大三下\计算机体系结构\image\image-20210701173734912.png)

* 用于多发射处理器的五种主要方法

  ![image-20210701174018104](D:\科大\大三下\计算机体系结构\image\image-20210701174018104.png)

* Superscalar DLX

  ![image-20210701174102692](D:\科大\大三下\计算机体系结构\image\image-20210701174102692.png)

* 多发射的问题

  ![image-20210701174226095](D:\科大\大三下\计算机体系结构\image\image-20210701174226095.png)

* 基于superscalar的循环展开 ppt22

  基于VLIW的循环展开：ppt24

* Trace Scheduling

  ![image-20210701174330306](D:\科大\大三下\计算机体系结构\image\image-20210701174330306.png)

* ![image-20210701174457707](D:\科大\大三下\计算机体系结构\image\image-20210701174457707.png)

* ![image-20210701174505714](D:\科大\大三下\计算机体系结构\image\image-20210701174505714.png)

* Superscalar的动态调度

  ![image-20210701174543987](D:\科大\大三下\计算机体系结构\image\image-20210701174543987.png)

  ![image-20210701174548786](D:\科大\大三下\计算机体系结构\image\image-20210701174548786.png)

* 多发射处理器受到的限制

  ![image-20210701174650904](D:\科大\大三下\计算机体系结构\image\image-20210701174650904.png)

  ![image-20210701174720077](D:\科大\大三下\计算机体系结构\image\image-20210701174720077.png)

#### 以动态调度、多发射和推测执行来挖掘指令级并行

#### Multithreading

* ![image-20210701174850568](D:\科大\大三下\计算机体系结构\image\image-20210701174850568.png)
* ![image-20210701175003046](D:\科大\大三下\计算机体系结构\image\image-20210701175003046.png)

![image-20210701175031767](D:\科大\大三下\计算机体系结构\image\image-20210701175031767.png)

* Simple multithreaded pipeline

  ![image-20210701175426381](D:\科大\大三下\计算机体系结构\image\image-20210701175426381.png)

  ![image-20210701175537788](D:\科大\大三下\计算机体系结构\image\image-20210701175537788.png)

  Thread scheduling policies

  ![image-20210701175805539](D:\科大\大三下\计算机体系结构\image\image-20210701175805539.png)

* superscalar

  ![image-20210701175842660](D:\科大\大三下\计算机体系结构\image\image-20210701175842660.png)

* chip multiprocessing CMP，多核处理器

  ![image-20210701180012812](D:\科大\大三下\计算机体系结构\image\image-20210701180012812.png)

* Vertical(Coarse-Grain) Multithreading  

  ![image-20210701180228634](D:\科大\大三下\计算机体系结构\image\image-20210701180228634.png)

* Fine-Grain Multithreading  ![image-20210701180417443](D:\科大\大三下\计算机体系结构\image\image-20210701180417443.png)

* Simultaneous Multithreading (SMT )

  ![image-20210701180619231](D:\科大\大三下\计算机体系结构\image\image-20210701180619231.png)

![image-20210701180642918](D:\科大\大三下\计算机体系结构\image\image-20210701180642918.png)

![image-20210701180743345](D:\科大\大三下\计算机体系结构\image\image-20210701180743345.png)



## 6.1 vector

#### 数据级并行的研究动机

##### 传统指令级并行技术的问题

* ![image-20210701201535871](D:\科大\大三下\计算机体系结构\image\image-20210701201535871.png)
* 应用需求和技术发展推动DLP兴起

##### SIMD结构的优势

* ![image-20210701201726883](D:\科大\大三下\计算机体系结构\image\image-20210701201726883.png)

##### 数据级并行的种类

* ![image-20210701201748899](D:\科大\大三下\计算机体系结构\image\image-20210701201748899.png)

#### 向量体系结构

* 向量处理模型
  * 向量处理机具有更高层次的操作，一条向量指令可以处理N个或N对操作数（处理对象是向量）  

* 起源-超级计算机

##### 向量处理机的基本特性及结构

* 基本特性![image-20210701201928216](D:\科大\大三下\计算机体系结构\image\image-20210701201928216.png)

* 基本结构

  ![image-20210701202007737](D:\科大\大三下\计算机体系结构\image\image-20210701202007737.png)

  ![image-20210701202051826](D:\科大\大三下\计算机体系结构\image\image-20210701202051826.png)

* vector Instruction Set 优势

  ![image-20210701202212311](D:\科大\大三下\计算机体系结构\image\image-20210701202212311.png)

* 向量处理机的基本组成单元

  ![image-20210701202402718](D:\科大\大三下\计算机体系结构\image\image-20210701202402718.png)

* Vector Instruction parallelism

  ![image-20210701202555120](D:\科大\大三下\计算机体系结构\image\image-20210701202555120.png)

  ![image-20210701202653024](D:\科大\大三下\计算机体系结构\image\image-20210701202653024.png)

* vector execution time

  ![image-20210701202841419](D:\科大\大三下\计算机体系结构\image\image-20210701202841419.png)

* ![image-20210701203037512](D:\科大\大三下\计算机体系结构\image\image-20210701203037512.png)

* VMIPS Start-up Time

  ![image-20210701203301769](D:\科大\大三下\计算机体系结构\image\image-20210701203301769.png)

* Strip mining(分段开采)

  ![image-20210701203350325](D:\科大\大三下\计算机体系结构\image\image-20210701203350325.png)

##### 性能评估

* Common vector metrics

  ![image-20210701204204825](D:\科大\大三下\计算机体系结构\image\image-20210701204204825.png)

* Interleaved vector memory system

  ![image-20210701204740840](D:\科大\大三下\计算机体系结构\image\image-20210701204740840.png)

* vector Stride

  ![image-20210701204858138](D:\科大\大三下\计算机体系结构\image\image-20210701204858138.png)

* Memory Operations

  ![image-20210701204914544](D:\科大\大三下\计算机体系结构\image\image-20210701204914544.png)

##### 优化

* Vector Chaining

  寄存器定向路径的向量机版本

  ![image-20210701205105333](D:\科大\大三下\计算机体系结构\image\image-20210701205105333.png)

  ![image-20210701205123245](D:\科大\大三下\计算机体系结构\image\image-20210701205123245.png)

* 有条件执行

  ![image-20210701205154506](D:\科大\大三下\计算机体系结构\image\image-20210701205154506.png)

  ![image-20210701205243638](D:\科大\大三下\计算机体系结构\image\image-20210701205243638.png)

* Sparse Matrices

  ![image-20210701205334323](D:\科大\大三下\计算机体系结构\image\image-20210701205334323.png)

#### Array processor和vector processor对比

* 数组机![image-20210701205610716](D:\科大\大三下\计算机体系结构\image\image-20210701205610716.png)
* 但注意都是处理的向量数据

#### 面向多媒体应用的SIMD指令集扩展 

* ![image-20210701205742496](D:\科大\大三下\计算机体系结构\image\image-20210701205742496.png)

* 此扩展与vectors的比较

  ![image-20210701205822989](D:\科大\大三下\计算机体系结构\image\image-20210701205822989.png)

总结

![image-20210701205928971](D:\科大\大三下\计算机体系结构\image\image-20210701205928971.png)

## 6.2 GPU

#### GPU起源

#### GPU基本的硬件结构

* ![image-20210701210631155](D:\科大\大三下\计算机体系结构\image\image-20210701210631155.png)
* ![image-20210701210702094](D:\科大\大三下\计算机体系结构\image\image-20210701210702094.png)

#### GPU的编程模型

* 编程模型与执行模型

  ![image-20210701210919767](D:\科大\大三下\计算机体系结构\image\image-20210701210919767.png)

* 并行程度开发的3个阶段：SISD，SIMD，MIMD/SPMD

  ![image-20210701211054009](D:\科大\大三下\计算机体系结构\image\image-20210701211054009.png)

  ![image-20210701211143541](D:\科大\大三下\计算机体系结构\image\image-20210701211143541.png)

  ![image-20210701211210855](D:\科大\大三下\计算机体系结构\image\image-20210701211210855.png)

  ![image-20210701211256954](D:\科大\大三下\计算机体系结构\image\image-20210701211256954.png)

* SPMD

  ![image-20210701211412498](D:\科大\大三下\计算机体系结构\image\image-20210701211412498.png)

* GPU是SIMD（SIMT)机器

  ![image-20210701211527635](D:\科大\大三下\计算机体系结构\image\image-20210701211527635.png)

* thread、warp、block、grid

* ![image-20210701211859823](D:\科大\大三下\计算机体系结构\image\image-20210701211859823.png)

* 硬件执行模型

  ![image-20210701211921553](D:\科大\大三下\计算机体系结构\image\image-20210701211921553.png)

* ![image-20210701212653585](D:\科大\大三下\计算机体系结构\image\image-20210701212653585.png)

* ![image-20210701212824041](D:\科大\大三下\计算机体系结构\image\image-20210701212824041.png)

* ![image-20210701213015050](D:\科大\大三下\计算机体系结构\image\image-20210701213015050.png)

* ![image-20210701213040140](D:\科大\大三下\计算机体系结构\image\image-20210701213040140.png)

* warps and warp-level FGMT

  ![image-20210701213259339](D:\科大\大三下\计算机体系结构\image\image-20210701213259339.png)

  Warp Instruction level Parallelism

  ![image-20210701213312905](D:\科大\大三下\计算机体系结构\image\image-20210701213312905.png)

  此过程里如何隐藏时延

  ![image-20210701213441218](D:\科大\大三下\计算机体系结构\image\image-20210701213441218.png)

* Warp-based SIMD  vs  Traditional SIMD

  ![image-20210701213542950](D:\科大\大三下\计算机体系结构\image\image-20210701213542950.png)

#### GPU的存储层次

* ![image-20210701212600129](D:\科大\大三下\计算机体系结构\image\image-20210701212600129.png)

* ![image-20210701213632947](D:\科大\大三下\计算机体系结构\image\image-20210701213632947.png)

* Global mem

  ![image-20210701213707679](D:\科大\大三下\计算机体系结构\image\image-20210701213707679.png)

* Shared mem

  ![image-20210701213733803](D:\科大\大三下\计算机体系结构\image\image-20210701213733803.png)

* registers

  ![image-20210701213814798](D:\科大\大三下\计算机体系结构\image\image-20210701213814798.png)

* local mem

  ![image-20210701213840046](D:\科大\大三下\计算机体系结构\image\image-20210701213840046.png)

* GPU L1 Cache

  ![image-20210701213922608](D:\科大\大三下\计算机体系结构\image\image-20210701213922608.png)

* GPU L2 Cache

  ![image-20210701213940042](D:\科大\大三下\计算机体系结构\image\image-20210701213940042.png)

* Constant mem

  ![image-20210701214010287](D:\科大\大三下\计算机体系结构\image\image-20210701214010287.png)

* constant cache

  ![image-20210701214034686](D:\科大\大三下\计算机体系结构\image\image-20210701214034686.png)

* ![image-20210701214123821](D:\科大\大三下\计算机体系结构\image\image-20210701214123821.png)

#### GPU分支处理（发散与汇聚）  

* Thread Block Scheduling

  ![image-20210701214244843](D:\科大\大三下\计算机体系结构\image\image-20210701214244843.png)

* Warp Scheduling：使用Scoreboard记录、round-robin、age of warp

  ![image-20210701214653241](D:\科大\大三下\计算机体系结构\image\image-20210701214653241.png)

* Warp-based SIMD  : 

  * 每个线程可以包含控制流指令  
  * 这些线程可以执行不同的控制流路径    

* 分支发散

  ![image-20210701214845845](D:\科大\大三下\计算机体系结构\image\image-20210701214845845.png)

  ![image-20210701214951558](D:\科大\大三下\计算机体系结构\image\image-20210701214951558.png)

  ![image-20210701215032684](D:\科大\大三下\计算机体系结构\image\image-20210701215032684.png)

* ![image-20210701230617956](D:\科大\大三下\计算机体系结构\image\image-20210701230617956.png)

* ![image-20210701230649657](D:\科大\大三下\计算机体系结构\image\image-20210701230649657.png)

![image-20210701230726216](D:\科大\大三下\计算机体系结构\image\image-20210701230726216.png)

* 动态合并![image-20210701230758104](D:\科大\大三下\计算机体系结构\image\image-20210701230758104.png)

  ![image-20210701230832127](D:\科大\大三下\计算机体系结构\image\image-20210701230832127.png)

  ![image-20210701230952577](D:\科大\大三下\计算机体系结构\image\image-20210701230952577.png)

* 但每个thread对应的lane是一定的
* 固定模式的存储器访问相对简单，当动态构成warp时，使得访问模式具有随机性，使得问题变得复杂 -》降低存储器访问的局部性 –》导致存储器带宽利用率的下降  

* ![image-20210701231258431](D:\科大\大三下\计算机体系结构\image\image-20210701231258431.png)

## 7.1 Coherence

#### 引言

* 通信模型和存储器的结构模型

  ![image-20210701232110273](D:\科大\大三下\计算机体系结构\image\image-20210701232110273.png)

* 两种通信模型

  ![image-20210701232141803](D:\科大\大三下\计算机体系结构\image\image-20210701232141803.png)

* 不同通信机制的优点

  ![image-20210701232237239](D:\科大\大三下\计算机体系结构\image\image-20210701232237239.png)

* 基于共享存储的MIMD机器分类

  ![image-20210701232258924](D:\科大\大三下\计算机体系结构\image\image-20210701232258924.png)

* 并行处理面临的挑战

  * 有限的并行性使机器要达到好的加速比十分困难
  * 多处理机中远程访问的较大延迟，即通信开销大

* 存储器访问的序问题

  ![image-20210701232612874](D:\科大\大三下\计算机体系结构\image\image-20210701232612874.png)

* 各类问题的解决思路

  ![image-20210701232749824](D:\科大\大三下\计算机体系结构\image\image-20210701232749824.png)

#### 集中式共享存储器体系结构

* Cache一致性问题

  ![image-20210701232828916](D:\科大\大三下\计算机体系结构\image\image-20210701232828916.png)

  ![image-20210701232902679](D:\科大\大三下\计算机体系结构\image\image-20210701232902679.png)

* 存储系统是一致的

  ![image-20210701233112781](D:\科大\大三下\计算机体系结构\image\image-20210701233112781.png)

* 实现一致性的基本方案

  ![image-20210701233303895](D:\科大\大三下\计算机体系结构\image\image-20210701233303895.png)

##### Cache一致性协议

![image-20210701233336295](D:\科大\大三下\计算机体系结构\image\image-20210701233336295.png)

###### 基于监听

* 写作废协议

  ![image-20210701233537815](D:\科大\大三下\计算机体系结构\image\image-20210701233537815.png)

* 写更新协议

  ![image-20210701233604933](D:\科大\大三下\计算机体系结构\image\image-20210701233604933.png)

* 两协议性能上的差别

  ![image-20210701233739814](D:\科大\大三下\计算机体系结构\image\image-20210701233739814.png)

* 监听协议的基本实现技术

  ![image-20210701234102029](D:\科大\大三下\计算机体系结构\image\image-20210701234102029.png)

  ![image-20210701234146678](D:\科大\大三下\计算机体系结构\image\image-20210701234146678.png)

  ![image-20210701234150779](D:\科大\大三下\计算机体系结构\image\image-20210701234150779.png)

  ![image-20210701234221317](D:\科大\大三下\计算机体系结构\image\image-20210701234221317.png)

  ![image-20210701234346592](D:\科大\大三下\计算机体系结构\image\image-20210701234346592.png)

  ![image-20210701234406486](D:\科大\大三下\计算机体系结构\image\image-20210701234406486.png)

* 以Write-back Cache为例

  ![image-20210701235010206](D:\科大\大三下\计算机体系结构\image\image-20210701235010206.png)

  ![image-20210701235027723](D:\科大\大三下\计算机体系结构\image\image-20210701235027723.png)

  ![image-20210701235053677](D:\科大\大三下\计算机体系结构\image\image-20210701235053677.png)

  ![image-20210702001007379](D:\科大\大三下\计算机体系结构\image\image-20210702001007379.png)

## 7.2

##### MESI

##### Coherency Misses

* ![image-20210702001624563](D:\科大\大三下\计算机体系结构\image\image-20210702001624563.png)

## 7.3 

* ![image-20210702001828728](D:\科大\大三下\计算机体系结构\image\image-20210702001828728.png)

#### 分布式共享存储器体系结构

##### 目录法

* 目录 in a Chip Multiprocessor

  ![image-20210702001947694](D:\科大\大三下\计算机体系结构\image\image-20210702001947694.png)

* 目录 in the Shared cache

  ![image-20210702002121602](D:\科大\大三下\计算机体系结构\image\image-20210702002121602.png)

* ![image-20210702002209613](D:\科大\大三下\计算机体系结构\image\image-20210702002209613.png)

* ![image-20210702002247341](D:\科大\大三下\计算机体系结构\image\image-20210702002247341.png)

* Read Miss by Processor P

  ![image-20210702002548907](D:\科大\大三下\计算机体系结构\image\image-20210702002548907.png)

* Write Miss Message by P to Directory

  ![image-20210702002700961](D:\科大\大三下\计算机体系结构\image\image-20210702002700961.png)

总结

![image-20210702002949252](D:\科大\大三下\计算机体系结构\image\image-20210702002949252.png)

#### 存储同一性

* 存储同一性的定义![image-20210702003040447](D:\科大\大三下\计算机体系结构\image\image-20210702003040447.png)
* ![image-20210702003116582](D:\科大\大三下\计算机体系结构\image\image-20210702003116582.png)
* 

#### 同步与通信

ppt 42-44

## 7.4 Consistency

* 单个处理器存储器操作的序

  ![image-20210702094253462](D:\科大\大三下\计算机体系结构\image\image-20210702094253462.png)

* 数据流处理器的存储器操作的序

  ![image-20210702094335000](D:\科大\大三下\计算机体系结构\image\image-20210702094335000.png)

* MIMD处理器中的存储器操作序

  ![image-20210702094452973](D:\科大\大三下\计算机体系结构\image\image-20210702094452973.png)

* 序的重要性

  ![image-20210702094530076](D:\科大\大三下\计算机体系结构\image\image-20210702094530076.png)

* 顺序同一性的存储器模型

  ![image-20210702094616646](D:\科大\大三下\计算机体系结构\image\image-20210702094616646.png)

* 顺序同一性的充分条件![image-20210702094717454](D:\科大\大三下\计算机体系结构\image\image-20210702094717454.png)

* ![image-20210702094823682](D:\科大\大三下\计算机体系结构\image\image-20210702094823682-1625190503973-1625190504155.png)

* TSO![image-20210702094916754](D:\科大\大三下\计算机体系结构\image\image-20210702094916754.png)

  

  ![image-20210702095222693](D:\科大\大三下\计算机体系结构\image\image-20210702095222693.png)

* 生产者消费者问题

  互斥问题

  ![image-20210702095712810](D:\科大\大三下\计算机体系结构\image\image-20210702095712810.png)
